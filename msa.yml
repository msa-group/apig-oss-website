Parameters:
  GatewayId:
    Type: String
    Default: 'gw-ctpq9vmm1hko22vleel0'
  EnvironmentId:
    Type: String
    Default: 'env-ctpqafmm1hkrb7pvq57g'
  Region:
    Type: String
    Default: 'cn-shanghai'
  Name:
    Type: String
    Default: 'oss-website'
  OssBucket:
    Type: String
    Default: 'oss-xxx'
  OssAddress: frontend-gray-cn-shanghai.oss-cn-shanghai-internal.aliyuncs.com


Composer:
  OssService:
    Component: apig.service
    Parameters:
      Port: 443
      AddressesName: {{Parameters.OssAddress}}
      Name: {{Subfix(Parameters.Name)}}

  RouteApi:
    Component: apig.http.api
    Parameters:
      ApiName: {{Subfix(Join([Parameters.Name, 'http')])}}

  OssWebsiteRoute:
    DependsOn:
      - OssService
      - RouteApi
    Component: apig.route
    Operation:
      ApiId: {{RosOutput(RouteApi, "HttpApiId")}}
      Name: {{Join([Parameters.Name, 'index'])}}
      Path: 'Prefix /'
      Scene: SingleService
      Services:
        - ServiceId: {{RosOutput(OssService, "ServiceId")}}
          Protocol: HTTP
          Weight: 100
    Parameters:
      HttpApiName: {{Subfix(Join([Parameters.Name, 'api')])}}
      RouteName: {{Join([Parameters.Name, 'index'])}}

  HttpRewritePolicy:
    DependsOn: OssWebsiteRoute
    Component: apig.router.policy
    Parameters:
      PolicyClassName: "HttpRewrite"
      PolicyConfig:
        Fn::Sub:
          - '{"pathType":"Prefix","host":"${HOST}","enable":true}'
          - HOST: {{Parameters.OssAddress}}
      RouteIds:
        - {{RosOutput(OssWebsiteRoute, "RouteId")}}
